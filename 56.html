<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
    integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
    crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"
    integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI"
    crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
    integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
<link rel="stylesheet" type="text/css" href="cards.css" />

<script src="cards.js" type="text/javascript"></script>

<script charset="utf-8" lang="Javascript">
    var seatNumber;
    var webSocket;
    var hand;
    var uuid = createUUID();
    var data;
    console.log(uuid);
    if (!document.cookie) {
        document.cookie = "key=" + uuid + ";max-age=2592000;"
    }
    function createUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }
    function refreshHand(data) {
        var cardsContent = "";
        //$("#activeHand")[0].innerHTML="";
        if (data.hand) {
            $.each(data.hand, function (index, value) {
                //alert(index + ": " + value);
                cardsContent += "<img id='card1' class='card' src='cards/" + value + ".svg' name=" + value + " onclick=selectCard(this)>";
                //$("#card" + (index + 1)).attr("src", "cards/" + value + ".svg");
                //$("#card" + (index + 1)).attr("name", value);


            });
        }
        if (cardsContent) {
            $("#activeHand")[0].innerHTML = cardsContent;
        }

        if (data.question) {
            resetPlayedCards();
            $("#bidSection").show();
            //$("#playSection").hide();
            $("#playButton").attr("disabled", true);
        }
        if (data.villi) {
            $("#trumpSection")[0].innerHTML = "Vili: " + data.villi + data.trump;
        }

        // if (data.message) {
        //     if (data.message.includes("P___bot")) {
        //         if (data.playsofar.length == 1) {
        //             resetPlayedCards();
        //         }
        //         var playerNo = (data.message.substring(7, 8));
        //         var card = (data.message.substring(data.message.length - 2));
        //         $('img[name="S' + playerNo + '"]').attr("src", "cards/" + card + ".svg");
        //     }

        //     //$("#trumpSection")[0].innerHTML = "Vili: " + data.villi + data.trump;
        // }
        if (data.playsofar) {
            showOtherCards(data.playsofar);
        }
        showVili();


    }
    function showVili() {
        if (data.VSF) {
            for (j = data.VSF.length - 1; j > -1; j--) {
                $('span[name="' + Object.keys(data.VSF[j])[0] + '"]')[0]
                    .innerHTML = data.VSF[j][Object.keys(data.VSF[j])[0]];
            }

        }
    }
    function passBid() {
        if (data.VSF.length == 0) {
            alert("Fist compulsory bid!!!");
            return;
        }
        //alert($("#bidSign").val())
        //alert($("#bidValue").val())
        data.AnsNo = data.quNo;
        data.Answer = 'P';
        webSocket.send(JSON.stringify(data));
        $("#bidSection").hide();
    }
    function sendBid() {
        var bidSign = $("#bidSign").val();
        var bidValue = $("#bidValue").val();

        if (!validateBid(bidSign, bidValue)) {
            return;
        }
        //alert($("#bidSign").val())
        //alert($("#bidValue").val())
        data.AnsNo = data.quNo;
        data.Answer = bidSign + bidValue;
        webSocket.send(JSON.stringify(data));
        $("#bidSection").hide();
    }
    function validateBid(bidSign, bidValue) {
        if (data.VSF.length > 0) {
            var lastBid = data.VSF[data.VSF.length - 1];
            var lastBidValue = Object.values(lastBid)[0].substring(1);
            if (bidValue <= lastBidValue) {
                alert("Invalid bid!!");
                return false;
            }
        }
        return true;
    }
    function getSeatNumber(seatNumber, pos) {
        return (seatNumber + pos === 6) ? 6 : ((seatNumber + pos) % 6)
    };
    function goToTable(seatNo) {
        seatNumber = parseInt(seatNo, 10);
        $("#activePlayer0")[0].innerHTML = "SeatNo: " + seatNo;
        $("#playedCardS0").attr("name", "S" + seatNo);
        $("#viliPlayerS0").attr("name", "S" + seatNo);
        $("#spinnerS0").attr("name", "S" + seatNo);



        $("#activePlayer1")[0].innerHTML = "SeatNo: " + getSeatNumber(seatNumber, 1);
        $("#playedCardS1").attr("name", "S" + getSeatNumber(seatNumber, 1));
        $("#viliPlayerS1").attr("name", "S" + getSeatNumber(seatNumber, 1));
        $("#spinnerS1").attr("name", "S" + getSeatNumber(seatNumber, 1));



        $("#activePlayer2")[0].innerHTML = "SeatNo: " + getSeatNumber(seatNumber, 2);
        $("#playedCardS2").attr("name", "S" + getSeatNumber(seatNumber, 2));
        $("#viliPlayerS2").attr("name", "S" + getSeatNumber(seatNumber, 2));
        $("#spinnerS2").attr("name", "S" + getSeatNumber(seatNumber, 2));



        $("#activePlayer3")[0].innerHTML = "SeatNo: " + getSeatNumber(seatNumber, 3);
        $("#playedCardS3").attr("name", "S" + getSeatNumber(seatNumber, 3));
        $("#viliPlayerS3").attr("name", "S" + getSeatNumber(seatNumber, 3));
        $("#spinnerS3").attr("name", "S" + getSeatNumber(seatNumber, 3));



        $("#activePlayer4")[0].innerHTML = "SeatNo: " + getSeatNumber(seatNumber, 4);
        $("#playedCardS4").attr("name", "S" + getSeatNumber(seatNumber, 4));
        $("#viliPlayerS4").attr("name", "S" + getSeatNumber(seatNumber, 4));
        $("#spinnerS4").attr("name", "S" + getSeatNumber(seatNumber, 4));



        $("#activePlayer5")[0].innerHTML = "SeatNo: " + getSeatNumber(seatNumber, 5);
        $("#playedCardS5").attr("name", "S" + getSeatNumber(seatNumber, 5));
        $("#viliPlayerS5").attr("name", "S" + getSeatNumber(seatNumber, 5));
        $("#spinnerS5").attr("name", "S" + getSeatNumber(seatNumber, 5));




        $("#seatSelection").hide();
        document.cookie = seatNo;
        webSocket = new WebSocket("ws://127.0.0.1:6789/key=" + seatNo + "&Room=0&seatNo=" + seatNo);
        webSocket.onmessage = function (message) {
            //console.log("here ");
            console.log(message);
            if (message.data) {
                //console.log(message.data);
                data = JSON.parse(message.data);
                refreshHand(data);

                if (data.event == 'play') {
                    //$("#playSection").show();
                    $("#playButton").attr("disabled", false);
                    showOtherCards(data.playsofar);

                }
            }

        }
        var contents;
        for (i = 28; i < 57; i++) {
            if (i == 28) {
                contents += "<option selected value=\"" + i + "\">" + i + "</option>";

            } else {
                contents += "<option value=\"" + i + "\">" + i + "</option>";
            }
        }

        $("#playingTable").show();
        $("#bidValue")[0].innerHTML = contents;
    }
    $(document).ready(function () {

    });

    function selectCard(card) {
        $(".card").removeClass("selectedCard");
        $(card).addClass("selectedCard");
    }
    function play() {
        $("#playedActiveCard").attr("src", $(".selectedCard").attr("src"));
        var selectedCard = $(".selectedCard").attr("name");
        var validPlay = validatePlay(selectedCard);
        if (!validPlay) {
            return;
        }
        data.card = selectedCard;
        //alert(data.card);
        webSocket.send(JSON.stringify(data));

        $(".selectedCard").remove();
        //$("#playSection").hide();
        $("#playButton").attr("disabled", true);
    }
    function validatePlay(card) {
        if (data.playsofar) {
            if (data.playsofar.length > 0) {
                var firstCard = Object.values(data.playsofar[0])[0];
                if (card.substring(0, 1) != firstCard.substring(0, 1)) {
                    if (ifSignPresent(firstCard)) {
                        alert("Invalid play!!")
                        return false;
                    }
                }
            }
        }
        return true;
    }
    function ifSignPresent(firstCard) {
        for (var i = 0; i < data.hand.length; i++) {
            if (data.hand[i].substring(0, 1) == firstCard.substring(0, 1)) {
                return true;
            }
        }
    }
    function resetPlayedCards() {
        for (i = 0; i < 6; i++) {
            //seatIndex--;
            $("#playedCardS" + i).attr("src", "cards/RED_BACK.svg");
        }
        //$("#playedActiveCard").attr("src", "cards/RED_BACK.svg");
    }

    function showOtherCards(otherCards) {
        resetPlayedCards();

        for (i = otherCards.length - 1; i > -1; i--) {
            //$("#playedCard" + Object.keys(otherCards[i])[0]).attr("src", "cards/" + otherCards[i][Object.keys(otherCards[i])[0]] + ".svg");
            $('img[name="' + Object.keys(otherCards[i])[0] + '"]')
                .attr("src", "cards/" + otherCards[i][Object.keys(otherCards[i])[0]] + ".svg");
        }

        for (var i = 0; i < 6; i++) {
            $('div[name="S' + i + '"]').hide();
        }
        if(otherCards.length>0){
        var lastPlayed = Object.keys(otherCards[otherCards.length - 1])[0];
        var nextPlay = "S" + (parseInt(lastPlayed.substring(1), 10) + 1) % 6;
        $('div[name="' + nextPlay + '"]').show();
        }

    }
</script>

<div class="container">

    <div class="container1" id="seatSelection">
        <button type="button" class="btn btn-primary" id="button1" onclick="goToTable(1)">1</button>
        <button type="button" class="btn btn-primary" onclick="goToTable(2)">2</button>
        <button type="button" class="btn btn-primary" onclick="goToTable(3)">3</button>
        <button type="button" class="btn btn-primary" onclick="goToTable(4)">4</button>
        <button type="button" class="btn btn-primary" onclick="goToTable(5)">5</button>
        <button type="button" class="btn btn-primary" onclick="goToTable(6)">6</button>
    </div>



    <div id="playingTable" style="display: none;">

        <div class="row" style="height: 100px;">
            <div class="col-sm-2">

            </div>
            <div class="col-sm-3">

            </div>
            <div class="col-sm-2">
                <div class="row card-header card">
                    <span id="activePlayer3"></span>
                </div>
                <div class="row ">
                    <div class="col-7 card-header card">
                        <span id="viliPlayerS3"></span>
                    </div>

                    <div class="col-5 card-header card">
                        <div class="spinner-grow" id="spinnerS3" style="width: 1.3rem; height: 1.3rem; display: none;"
                            role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                    </div>
                </div>

            </div>
            <div class="col-sm-3">
                <!---->
            </div>
            <div class="col-sm-2">
                <!---->
            </div>
        </div>
        <div class="row" style="height: 138px;">
            <div class="col-sm-2">
                <!---->
            </div>
            <div class="col-sm-3">
                <div class="row" style="height: 20px;">
                </div>
                <div class="row">
                    <div class="col">
                        <div class="row">
                            <div class="col card-header card">
                                <span id="activePlayer4"></span>
                            </div>
                        </div>
                        <div class="row ">
                            <div class="col-7 card-header card">
                                <span id="viliPlayerS4"></span>
                            </div>
                            <div class="col-5 card-header card">
                                <div id="spinnerS4" class="spinner-grow"
                                    style="width: 1.3rem; height: 1.3rem;; display: none;" role="status">
                                    <span class="sr-only">Loading...</span>
                                </div>
                            </div>


                        </div>
                    </div>
                    <div class="col">
                        <img id='playedCardS4' class="card" src='cards/RED_BACK.svg' onclick=""
                            style="border:5px solid black">
                    </div>
                </div>
            </div>
            <div class="col-sm-2">
                <img id='playedCardS3' class="card" src='cards/RED_BACK.svg' onclick="" style="border:5px solid red">

            </div>
            <div class="col-sm-3">
                <div class="row" style="height: 20px;">
                </div>
                <div class="row">
                    <div class="col">
                        <img id='playedCardS2' class="card" src='cards/RED_BACK.svg' onclick=""
                            style="border:5px solid black">
                    </div>
                    <div class="col ">
                        <div class="row ">
                            <div class="col card-header card">
                                <span id="activePlayer2"></span>
                            </div>
                        </div>
                        <div class="row ">
                            <div class="col-7 card-header card">
                                <span id="viliPlayerS2"></span>
                            </div>
                            <div class="col-5 card-header card">
                                <div id="spinnerS2" class="spinner-grow"
                                    style="width: 1.3rem; height: 1.3rem; ; display: none;" role="status">
                                    <span class="sr-only">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-sm-2">
                    <!---->
                </div>
            </div>
        </div>
        <div class="row" style="height: 10px;">
            <div class="col-sm-2">
                <!---->
            </div>
            <div class="col-sm-3">

            </div>
            <div class="col-sm-2">
                Fold </div>
            <div class="col-sm-3">

            </div>
            <div class="col-sm-2">
                <!---->
            </div>
        </div>
        <div class="row" style="height: 138px;">
            <div class="col-sm-2">
                <div class="row card">
                    <div class="card-header">
                        Details
                    </div>
                    <div class="card-header">
                        <span class="card-text" id="trumpSection"></span>
                    </div>
                </div>
            </div>

            <div class="col-sm-3">
                <div class="row">
                    <div class="col">
                        <div class="row">
                            <div class="col card-header card">
                                <span id="activePlayer5"></span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-7 card-header card">
                                <span id="viliPlayerS5"></span>
                            </div>
                            <div class="col-5 card-header card">
                                <div id="spinnerS5" class="spinner-grow"
                                    style="width: 1.3rem; height: 1.3rem; ; display: none;" role="status">
                                    <span class="sr-only">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col">
                        <img id='playedCardS5' class="card" src='cards/RED_BACK.svg' onclick=""
                            style="border:5px solid red">
                    </div>
                </div>

            </div>
            <div class="col-sm-2">
                <div class="row" style="height: 20px;">
                </div>
                <img id='playedCardS0' class="card" src='cards/RED_BACK.svg' onclick="" style="border:5px solid black">
            </div>
            <div class="col-sm-3">
                <div class="row ">
                    <div class="col">
                        <img id='playedCardS1' class="card" src='cards/RED_BACK.svg' onclick=""
                            style="border:5px solid red">
                    </div>
                    <div class="col ">
                        <div class="row">
                            <div class="col card-header card">
                                <span id="activePlayer1"></span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-7 card-header card">
                                <span id="viliPlayerS1"></span>
                            </div>
                            <div class="col-5 card-header card">
                                <div id="spinnerS1" class="spinner-grow"
                                    style="width: 1.3rem; height: 1.3rem; ; display: none;" role="status">
                                    <span class="sr-only">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-sm-2">
                    <!---->
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-3">


            </div>
            <div class="col-sm-7">
                <div class="row">
                    <div class="col-1 card-header card">
                        <div id="spinnerS0" class="spinner-grow" style="width: 1.3rem; height: 1.3rem; ; display: none;"
                            role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                    </div>
                    <span id="activePlayer0" class="card-header card"></span>
                    <span id="viliPlayerS0" class="card-header card"></span>

                </div>
                <div class="row text-center">
                    <div class="btn-group" id="bidSection" style="display: none;">
                        <!-- <div id="bidSection"> -->
                        <select class="browser-default custom-select selectpicker" id="bidSign">
                            <option value="S" selected> ♠ Spade</option>
                            <option value="C">♣ Club</option>
                            <option value="D">♦ Diamond</option>
                            <option value="H">♥ Heart</option>

                        </select>

                        <select class="browser-default custom-select" id="bidValue">

                        </select>
                        <div class="btn-group">
                            <button type="button" class="btn btn-primary" id="button1" onclick="sendBid()">Bid</button>
                            <button type="button" class="btn btn-primary" id="button1" onclick="passBid()">Pass</button>
                        </div>
                        <!-- </div> -->
                    </div>



                    <div class="col text-center">
                        <div class="text-center" id="playSection">
                            <button type="button" class="btn btn-primary text-center" id="playButton" onclick="play()"
                                disabled="true">Play</button>
                        </div>
                    </div>
                </div>

                <div class="hand hhand active-hand" id="activeHand">
                    <img id='card1' class="card" src='cards/SA.svg' onclick=selectCard(this)>
                    <img id='card2' class="card" src='cards/SK.svg' onclick=selectCard(this)>
                    <img id='card3' class="card" src='cards/SK.svg' onclick=selectCard(this)>
                    <img id='card4' class="card" src='cards/SK.svg' onclick=selectCard(this)>
                    <img id='card5' class="card" src='cards/SK.svg' onclick=selectCard(this)>
                    <img id='card6' class="card" src='cards/SK.svg' onclick=selectCard(this)>
                    <img id='card7' class="card" src='cards/SK.svg' onclick=selectCard(this)>
                    <img id='card8' class="card" src='cards/SK.svg' onclick=selectCard(this)>
                </div>
            </div>
            <div class="col-sm-2">

            </div>
        </div>
    </div>

</div>